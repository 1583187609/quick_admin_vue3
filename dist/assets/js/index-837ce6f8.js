import{_ as e}from"./index-df51bfa3.js";import{d as t,c as a,e as s}from"./mock-82b0ce6c.js";import{M as o}from"./@element-plus-df896130.js";import r from"./Index-7e173880.js";import i from"./UserItem-7cd39fb9.js";import n from"./Index-35d004ba.js";import{u as l}from"./index-b1e3ddeb.js";import{d as p}from"./dayjs-70c6b0b9.js";import"./lodash-e3f0fdcb.js";import"./nprogress-61860a65.js";import d from"./LoadMore-9a1497a0.js";import m from"./SearchMsg-b60533e7.js";import{d as c,D as f,$ as u,f as g,ai as v,o as h,P as j,Q as I,a as U,V as y,W as M,c as b,F as k,a9 as D,U as x,u as C,T as _,bm as S,bk as A}from"./@vue-2b5461a3.js";import"./element-plus-568f2232.js";import"./lodash-es-d4f5f48c.js";import"./@vueuse-2ec33eb0.js";import"./@popperjs-b78c3215.js";import"./@ctrl-91de2ec7.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-36fbce82.js";import"./qs-349681aa.js";import"./call-bind-2df1f9b5.js";import"./get-intrinsic-176af07e.js";import"./es-errors-c8ed318b.js";import"./has-symbols-456daba2.js";import"./has-proto-c2a23985.js";import"./function-bind-afbcd6f2.js";import"./hasown-c3b72c9b.js";import"./set-function-length-af5653fd.js";import"./define-data-property-80a6b8d7.js";import"./es-define-property-c2edbfb6.js";import"./gopd-991ce5b0.js";import"./has-property-descriptors-52e43c9d.js";import"./side-channel-4fcbcfeb.js";import"./object-inspect-1fd817f8.js";import"./axios-b9284f1b.js";import"./pinia-5cbb4d0f.js";import"./mock-281f81b0.js";import"./mockjs-21e11712.js";import"./vue-router-27db6c8e.js";import"./vite-plugin-mock-fcfbfb18.js";import"./path-to-regexp-83a43451.js";import"./vue-i18n-aaa7cda4.js";import"./@intlify-34459bb4.js";import"./xlsx-8a748b86.js";import"./platform-d2966cfd.js";import"./CustomMsg-5a7f261c.js";import"./AudioMsg-60067686.js";import"./VideoMsg.vue_vue_type_script_setup_true_lang-6b3ed8ff.js";import"./ImgMsg-67d99f85.js";const H=e=>(S("data-v-5b0ca4d0"),e=e(),A(),e),T={class:"f-sb-s f-1",style:{height:"100%"}},B={class:"section f-1 f-fs-s-c"},w={class:"header f-c-c f-0"},z={class:"section f-1 f-fs-s-c"},R={class:"header f-c-c f-0"},W={class:"section f-2 f-fs-s-c"},N={class:"header f-sb-fe f-0"},O={class:"f-fs-c"},P={class:"f-fs-c"},V={class:"nickname line-1"},$=H((()=>U("div",null,"与",-1))),E={class:"f-fs-c"},K={class:"nickname line-1"},Y=H((()=>U("div",{class:"line-1"},"的聊天记录",-1))),q={class:"first-time line-1"},J={key:0,class:"tips time"},F=e(c({name:"ChatRecords",__name:"index",setup(e){const{getSearchOpts:c}=l(),S=f("openPopup"),A=[8001,8003,8004,8005,8006],H=u({}),F=u({loading:!1,activeId:"",list:[],hasMore:!0,total:0,params:{page:1,pageSize:10}}),Q=u({loading:!1,activeId:"",list:[],hasMore:!0,total:0,params:{page:1,pageSize:10}}),G=u({loading:!1,list:[],prevHasMore:!0,nextHasMore:!1,total:0,params:{pageSize:20,prevCreatedAt:0},headInfo:{fromUser:{},toUser:{},firstDate:""}}),L=[{prop:"fromUserId",label:"用户ID"},{prop:"fromUserCode",label:"号码牌"},{prop:"fromUserNickname",label:"昵称"},{prop:"toUserId",label:"好友ID"},{prop:"msgWord",label:"关键词"},{prop:"friendNumScope",label:"好友数量",type:"BaseNumberRange"},c("school",{prop:"fromUserSchoolId",label:"学校"}),c("company",{prop:"fromUserCompanyId",label:"公司"}),{prop:"fromUserRegisterTimeScope",label:"注册时间",type:"date-picker"},{prop:"chatTimeScope",label:"会话时间",type:"date-picker"}];function X(e,t,a=18e4){return 0===t||G.list[t-1].createdAt<e.createdAt-a}function Z(e){const t=p().diff(p(e),"hours"),a=p().diff(p(e),"minutes");return t>1?p(e).format("YYYY-MM-DD HH:mm:ss"):a>1?`${a}分钟前`:"刚刚"}async function ee(e){var t,a;const{hasMore:o,list:r}=F,{page:i}=F.params;if(o||1===i){F.loading=!0;try{const o=await s(e),{list:i,total:n,hasMore:l,currentPage:p}=o;1===p&&(F.params.page=1),Object.assign(F,{list:1===p?i:r.concat(i),total:n,hasMore:l},1===p?{activeId:(null==(a=null==(t=null==i?void 0:i[0])?void 0:t.fromUserData)?void 0:a.id)??""}:void 0)}catch(n){}finally{F.loading=!1}}}function te(e){if(!e)return;const{hasMore:a,list:s,params:o}=Q,{page:r}=o;(a||1===r)&&(Q.loading=!0,t({fromUserId:e,msgWord:H.msgWord,chatTimeScope:H.chatTimeScope,...o}).then((e=>{const{list:t,total:a,hasMore:o,currentPage:r}=e;1===r&&(Q.params.page=1),Object.assign(Q,{list:1===r?t:s.concat(t),total:a,hasMore:o})})).finally((()=>{Q.loading=!1})))}function ae(e,t,s="prev"){if(!e||!t)return;const{prevHasMore:o,nextHasMore:r,list:i,params:n}=G,{page:l,prevCreatedAt:p}=n,d=0===p;if(!d){if("next"===s&&!r)return;if("prev"===s&&!o)return}G.loading=!0,a({fromUserId:e,toUserId:t,queryDirection:s,...n}).then((e=>{const{list:t,total:a,hasMore:o,firstDate:r,fromUser:n,toUser:l}=e,p=t.map((e=>{const{msgContent:t={},...a}=e,{Data:s,Ext:o}=e.msgContent;return t.Data=JSON.parse(s||"{}"),t.Ext=JSON.parse(o||"{}"),{fromUser:n.id===e.fromUserId?n:l,toUser:l.id===e.toUserId?l:n,msgContent:t,...a}})),m=d?p:"next"===s?[...i,...p]:[...p,...i];Object.assign(G,{list:m,total:a,[`${s}HasMore`]:o,headInfo:{firstDate:r,fromUser:n,toUser:l}})})).finally((()=>{G.loading=!1}))}function se(e,t){var a;"from"===e?(F.activeId=null==(a=null==t?void 0:t.fromUserData)?void 0:a.id,Q.params.page=1):"to"===e&&(Q.activeId=t.toUserData.id,Object.assign(G,{nextHasMore:!0,prevHasMore:!0,prevCreatedAt:0}))}function oe(e){"from"===e?(F.params.page++,ee({...H,...F.params})):"to"===e&&(Q.params.page++,te(F.activeId))}function re(e){const t="prev"===e?G.list[0]:G.list.slice(-1)[0];t&&(G.params.prevCreatedAt=t.createdAt+("prev"===e?-1:1),ae(F.activeId,Q.activeId,e))}function ie(e,t,a){S(`【${e.nickname||"-"}】与【${t.nickname||"-"}】的聊天记录搜索`,{component:m,attrs:{fromUser:e,toUser:t,keyWord:a,onSelect:ne}})}function ne(e,t,a){G.list=[],G.prevHasMore=!0,G.nextHasMore=!0,G.params.prevCreatedAt=e.createdAt+1,ae(F.activeId,Q.activeId),a()}return g((()=>F.activeId),(e=>{Q.params.page=1,Q.activeId="",Q.list=[],G.list=[],te(e)}),{immediate:!0}),g((()=>Q.activeId),(async e=>{if(e){const t=H.msgWord,s=F.activeId,o=await async function(e,t,s){if(s)return await a({fromUserId:e,toUserId:t,msgWord:s}).then((e=>{var t;if((null==(t=null==e?void 0:e.list)?void 0:t.length)>=2){const{fromUser:t,toUser:a}=e;return{fromUser:t,toUser:a}}return null})).catch((()=>null))}(s,e,t);if(o){const{fromUser:e,toUser:a}=o;ie(e,a,t)}else G.params.prevCreatedAt=0,ae(F.activeId,e)}else G.list=[]}),{immediate:!1}),(e,t)=>{const a=v("el-tooltip"),s=v("el-button");return h(),j(r,{modelValue:H,"onUpdate:modelValue":t[5]||(t[5]=e=>H=e),fields:L,fetch:ee,pageAttrs:{pageSizes:[5,10,15,20,25]},pagination:{currPage:1,pageSize:10},showPagination:!1},{list:I((({list:e,total:r,hasMore:l})=>[U("div",T,[U("section",B,[U("header",w,[U("b",null,"搜索结果 ("+y(F.list.length)+"/"+y(F.total)+")",1)]),M(d,{class:"f-1",onReachBottom:t[0]||(t[0]=e=>oe("from")),paddingBottom:F.hasMore?0:250,loading:F.loading,emptyTips:"换个姿势搜搜看~"},{default:I((()=>[(h(!0),b(k,null,D(F.list,((e,t)=>{var a;return h(),j(i,{userDataKey:"fromUserData",onClick:t=>se("from",e),data:e,active:F.activeId===(null==(a=null==e?void 0:e.fromUserData)?void 0:a.id),isSearchResult:"",key:t},null,8,["onClick","data","active"])})),128))])),_:2},1032,["paddingBottom","loading"])]),U("section",z,[U("header",R,[U("b",null,"TA的好友 ("+y(Q.list.length)+"/"+y(Q.total)+")",1)]),M(d,{class:"f-1",onReachBottom:t[1]||(t[1]=e=>oe("to")),paddingBottom:Q.hasMore?0:250,loading:Q.loading,emptyTips:F.activeId?"暂无好友哦~":"请在左侧选择用户"},{default:I((()=>[(h(!0),b(k,null,D(Q.list,((e,t)=>(h(),j(i,{userDataKey:"toUserData",onClick:t=>se("to",e),data:e,active:Q.activeId===e.toUserData.id,key:t},null,8,["onClick","data","active"])))),128))])),_:2},1032,["paddingBottom","loading","emptyTips"])]),U("section",W,[U("header",N,[U("div",O,[U("div",P,[x(" 【 "),M(a,{content:G.headInfo.fromUser.nickname},{default:I((()=>[U("span",V,y(G.headInfo.fromUser.nickname||"-"),1)])),_:1},8,["content"]),x("】 ")]),$,U("div",E,[x(" 【 "),M(a,{content:G.headInfo.toUser.nickname},{default:I((()=>[U("span",K,y(G.headInfo.toUser.nickname||"-"),1)])),_:1},8,["content"]),x(" 】 ")]),Y]),M(a,{content:"首次建立会话时间："+G.headInfo.firstDate},{default:I((()=>[U("span",q,y(G.headInfo.firstDate),1)])),_:1},8,["content"]),M(s,{onClick:t[2]||(t[2]=e=>ie(G.headInfo.fromUser,G.headInfo.toUser,H.msgWord)),icon:C(o),size:"small",disabled:!Q.activeId,type:"primary",class:"ml-o",plain:"",round:""},{default:I((()=>[x("搜索")])),_:1},8,["icon","disabled"])]),M(d,{class:"f-1","padding-top":"16",paddingBottom:G.hasMore?16:250,loading:G.loading,topHasMore:G.prevHasMore,onReachTop:t[3]||(t[3]=e=>re("prev")),onReachBottom:t[4]||(t[4]=e=>re("next")),emptyTips:Q.activeId?"暂无聊天记录哦~":"请在左侧选择TA的好友"},{default:I((()=>[(h(!0),b(k,null,D(G.list,((e,t)=>{var a,s;return h(),b(k,{key:t},[X(e,t)?(h(),b("div",J,y(Z(e.createdAt)),1)):_("",!0),M(n,{data:e,userInfo:G.headInfo[(Q.activeId===e.fromUser.id?"to":"from")+"User"],position:"TIMCustomElem"!==e.msgType||A.includes(null==(s=null==(a=e.msgContent)?void 0:a.Data)?void 0:s.type)?Q.activeId===e.fromUser.id?"left":"right":"center"},null,8,["data","userInfo","position"])],64)})),128))])),_:2},1032,["paddingBottom","loading","topHasMore","emptyTips"])])])])),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-5b0ca4d0"]]);export{F as default};
